name: "Update Changelog"

on:
    release:
        types: [published]
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

jobs:
    update-changelog:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository code
              uses: actions/checkout@v4
              with:
                  # fetch-depth: 0 is important for git-chglog to get full history
                  fetch-depth: 0

            - name: Setup git-chglog
              # This step installs the git-chglog tool
              uses: carlkidcrypto/os-specific-runner@v2.1.2
              with:
                  linux: |
                      # Install Go
                      sudo snap install go --classic
                      # Install git-chglog using Go
                      go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest

            - name: Generate CHANGELOG.md
              id: generate
              uses: carlkidcrypto/os-specific-runner@v2.1.2
              with:
                  linux: |
                      # Remove existing CHANGELOG.md to ensure a fresh generation
                      rm -f CHANGELOG.md
                      # Add Go binaries path to the environment, so git-chglog can be found
                      echo "PATH=$PATH:/home/runner/go/bin" >> $GITHUB_ENV
                      # Generate the CHANGELOG.md file
                      # The --config path should be relative to the workspace root or an absolute path
                      # Ensure this path is correct for your repository's structure
                      /home/runner/go/bin/git-chglog --config .chglog/config.yml -o CHANGELOG.md
                      # IMPORTANT: Removed git config, git add, git commit, git push
                      # These actions are now handled by peter-evans/create-pull-request@v7
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    create-changelog-pr:
        runs-on: ubuntu-latest
        needs: update-changelog

        steps:
            - name: Checkout repository code (for create-pull-request)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Create Pull Request
              id: create-pr
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: update CHANGELOG.md"
                  title: "üìù Update Changelog"
                  body: |
                      This PR updates the CHANGELOG.md to include all releases.
                      - Generated using git-chglog
                      - Triggered by: ${{ github.event_name }}
                      - Auto-merge enabled
                  branch: update-changelog-${{ github.run_id }}
                  base: main
                  delete-branch: true
                  labels: documentation, automated-pr

            - name: Enable Auto-merge
              run: |
                  PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
                  # Extract the PR number from the URL
                  PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
                  echo "Attempting to auto-merge PR #$PR_NUMBER"
                  # Use 'gh pr merge --auto --merge' to enable auto-merge and merge when possible
                  gh pr merge --auto --merge "$PR_NUMBER"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
