name: "Update Changelog"

on:
    release:
        types: [published]
    workflow_dispatch:
    push:
        paths:
            - '.github/workflows/auto_change_log.yml'
            - '.chglog/**'

permissions:
    contents: write
    pull-requests: write

jobs:
    create-changelog-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
              with:
                  fetch-depth: 0

            - name: Cache Go modules and binaries
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                      ~/go/bin
                  key: ${{ runner.os }}-go-git-chglog-${{ hashFiles('**/go.sum') }}
                  restore-keys: |
                      ${{ runner.os }}-go-git-chglog-
                      ${{ runner.os }}-go-

            - name: Setup git-chglog
              uses: carlkidcrypto/os-specific-runner@39336e3ec1a53bcdce44b9e9388da204f79203d9 # v2.1.3
              with:
                  linux: |
                      # Install Go if not cached
                      if ! command -v go &> /dev/null; then
                          sudo snap install go --classic
                      fi
                      # Install git-chglog if not cached
                      if [ ! -f ~/go/bin/git-chglog ]; then
                          go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest
                      fi
                      # Ensure git-chglog is in PATH
                      echo "$HOME/go/bin" >> $GITHUB_PATH

            - name: Generate CHANGELOG.md
              id: generate
              run: |
                  # Store old CHANGELOG.md for comparison
                  if [ -f CHANGELOG.md ]; then
                      cp CHANGELOG.md CHANGELOG.md.old
                  fi
                  
                  # Generate new changelog
                  rm -f CHANGELOG.md
                  git-chglog --config .chglog/config.yml -o CHANGELOG.tmp
                  
                  # Add timestamp header
                  TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S %Z")
                  echo "Last Updated: $TIMESTAMP" > CHANGELOG.md.new
                  echo "" >> CHANGELOG.md.new
                  cat CHANGELOG.tmp >> CHANGELOG.md.new
                  mv CHANGELOG.md.new CHANGELOG.md
                  rm CHANGELOG.tmp
                  
                  # Check if CHANGELOG actually changed
                  if [ -f CHANGELOG.md.old ]; then
                      if diff -q CHANGELOG.md CHANGELOG.md.old > /dev/null; then
                          echo "has_changes=false" >> $GITHUB_OUTPUT
                      else
                          echo "has_changes=true" >> $GITHUB_OUTPUT
                      fi
                      rm CHANGELOG.md.old
                  else
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Pull Request
              id: create-pr
              if: steps.generate.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: update CHANGELOG.md"
                  title: "üìù Update Changelog"
                  body: |
                      This PR updates the CHANGELOG.md to include all releases.
                      - Generated using git-chglog
                      - Triggered by: ${{ github.event_name }}
                      - Run ID: ${{ github.run_id }}
                      - Auto-merge enabled
                      
                      ### Changes
                      The changelog has been automatically generated from git tags and commits.
                      Please review the changes to ensure accuracy before merging.
                  branch: update-changelog-${{ github.run_id }}
                  base: main
                  delete-branch: true
                  labels: documentation, automated-pr

            - name: Enable Auto-merge
              if: steps.create-pr.outputs.pull-request-number != ''
              # Removed 'continue-on-error: true' so job will fail on error
              run: |
                  PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
                  PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
                  echo "Attempting to auto-merge PR #$PR_NUMBER"
                  gh pr merge --auto --merge "$PR_NUMBER"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
