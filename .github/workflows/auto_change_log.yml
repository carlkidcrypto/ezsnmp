name: "Update Changelog"

on:
    release:
        types: [published]
    workflow_dispatch:
    push:
        paths:
            - '.github/workflows/auto_change_log.yml'
            - '.chglog/**'

permissions:
    contents: write
    pull-requests: write

jobs:
    create-changelog-pr:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v5
              with:
                  fetch-depth: 0

            - name: Cache Go modules and binaries
              uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                      ~/go/bin
                  key: ${{ runner.os }}-go-git-chglog-v1
                  restore-keys: |
                      ${{ runner.os }}-go-git-chglog-

            - name: Setup git-chglog
              uses: carlkidcrypto/os-specific-runner@39336e3ec1a53bcdce44b9e9388da204f79203d9 # v2.1.3
              with:
                  linux: |
                      # Install Go if not cached
                      if ! command -v go > /dev/null 2>&1; then
                          sudo snap install go --classic
                      fi
                      # Install git-chglog if not already available
                      if ! command -v git-chglog > /dev/null 2>&1; then
                          go install github.com/git-chglog/git-chglog/cmd/git-chglog@latest
                      fi
                      # Ensure git-chglog is in PATH
                      echo "$HOME/go/bin" >> $GITHUB_PATH

            - name: Generate CHANGELOG.md
              id: generate
              run: |
                  # Generate new changelog content (without timestamp)
                  git-chglog --config .chglog/config.yml -o CHANGELOG.tmp
                  
                  # Extract old changelog content (without timestamp) for comparison
                  if [ -f CHANGELOG.md ]; then
                      # Check if file has timestamp header (starts with "Last Updated:")
                      if head -n 1 CHANGELOG.md | grep -q "^Last Updated:"; then
                          # Skip the first 2 lines (timestamp header and blank line)
                          tail -n +3 CHANGELOG.md > CHANGELOG.md.old
                      else
                          # No timestamp header, use entire file
                          cp CHANGELOG.md CHANGELOG.md.old
                      fi
                      
                      # Compare new and old content (excluding timestamp)
                      if cmp -s CHANGELOG.tmp CHANGELOG.md.old; then
                          echo "has_changes=false" >> $GITHUB_OUTPUT
                          echo "No changes detected in changelog content"
                      else
                          echo "has_changes=true" >> $GITHUB_OUTPUT
                          echo "Changes detected in changelog content"
                      fi
                      rm CHANGELOG.md.old
                  else
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                      echo "First time generating changelog"
                  fi
                  
                  # Add timestamp header to final CHANGELOG.md
                  TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S %Z")
                  echo "Last Updated: $TIMESTAMP" > CHANGELOG.md
                  echo "" >> CHANGELOG.md
                  cat CHANGELOG.tmp >> CHANGELOG.md
                  rm CHANGELOG.tmp
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Pull Request
              id: create-pr
              if: steps.generate.outputs.has_changes == 'true'
              uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v7
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: update CHANGELOG.md"
                  title: "üìù Update Changelog"
                  body: |
                      This PR updates the CHANGELOG.md to include all releases.
                      - Generated using git-chglog
                      - Triggered by: ${{ github.event_name }}
                      - Run ID: ${{ github.run_id }}
                      - Auto-merge enabled
                      
                      ### Changes
                      The changelog has been automatically generated from git tags and commits.
                      Please review the changes to ensure accuracy before merging.
                  branch: update-changelog-${{ github.run_id }}
                  base: main
                  delete-branch: true
                  labels: documentation, automated-pr

            - name: Enable Auto-merge
              if: steps.create-pr.outputs.pull-request-number != ''
              # Removed 'continue-on-error: true' so job will fail on error
              run: |
                  PR_URL="${{ steps.create-pr.outputs.pull-request-url }}"
                  PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
                  echo "Attempting to auto-merge PR #$PR_NUMBER"
                  gh pr merge --auto --merge "$PR_NUMBER"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
