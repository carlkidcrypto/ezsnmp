# Refer to the following link for help
# https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/

name: "Pull Request Sphinx Docs Check"

on:
  release:
    types: [published]

jobs:
  sphinx_docs_build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Set up Python 3.11 env for sphinx...
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Build Requirements
        uses: carlkidcrypto/os-specific-runner@v2.1.1
        with:
          linux: |
            sudo apt install -y libsnmp-dev g++ python3-dev;
            cd /home/runner/work/ezsnmp/ezsnmp/ &&
            python -m pip install . --user;

      - name: Run sphinx...
        uses: carlkidcrypto/os-specific-runner@v2.1.1
        with:
          linux: |
            cd /home/runner/work/ezsnmp/ezsnmp/sphinx_docs_build;
            if [ -f tests/requirements.txt ]; then pip install -r tests/requirements.txt; fi
            mkdir source/_static;
            mkdir source/_templates;
            make clean && make html SPHINXOPTS="-W"

      - name: Upload Release Asset
        id: upload-release-asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./sphinx_docs_build/build/html/
          asset_name: documentation.zip
          asset_content_type: application/zip