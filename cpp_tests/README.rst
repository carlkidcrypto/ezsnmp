==========
C++ Tests
==========

Overview
========
This directory contains C++ unit tests for the EzSnmp library's native C++ components.
These tests validate the low-level SNMP operations and C++ class functionality.

Purpose
=======
The C++ tests ensure that:

* SessionBase class operations work correctly
* Exception handling in C++ layer functions properly
* Data type conversions between C++ and Python are accurate
* Net-SNMP library integration is stable
* Memory management is correct and leak-free

Test Components
===============
The tests in this directory cover:

* SNMP session management
* GET, SET, WALK, BULKGET, and BULKWALK operations
* Error handling and exception propagation
* Thread safety of C++ components
* SWIG interface bindings

Test Skip Macro
===============
The C++ tests use a custom macro ``EZSNMP_SKIP_TEST_AND_RETURN_IF_NO_DATA`` for skipping tests when SNMP data is unavailable. This macro provides backward compatibility with older Google Test versions:

* For newer GTest versions (with ``GTEST_SKIP``): Uses ``GTEST_SKIP()`` for proper test skipping
* For older GTest versions: Prints a skip message and returns early

**Important**: This macro causes the calling function to return early. Use it only at function scope, not inside loops or other control structures.

Example usage::

    if (!data_available) {
        EZSNMP_SKIP_TEST_AND_RETURN_IF_NO_DATA("SNMP agent returned no data");
    }

Usage
=====
For detailed instructions on building and running C++ tests, please refer to the 
`Development Guide <../sphinx_docs_build/source/development.rst>`_.

Prerequisites
=============
To run these tests, you need:

* Meson and Ninja build tools
* Net-SNMP development libraries
* Google Test framework (or similar C++ testing framework)
* C++ compiler with C++17 support

Related Documentation
=====================
* `Main README <../README.rst>`_
* `Development Guide <../sphinx_docs_build/source/development.rst>`_
* `Python Tests <../python_tests/README.rst>`_
* `C++ Source Code <../ezsnmp/src/>`_

Code Coverage
=============
The C++ tests aim for high code coverage. However, some code paths are difficult or 
impossible to test in unit tests:

**Untestable in Unit Tests (require integration testing or fault injection):**

* Memory allocation failures (calloc, strdup failures) - require fault injection
* Buffer overflow/truncation in net-snmp functions - requires specific data conditions
* Specific SNMP error conditions (timeouts, connection errors, packet errors) - requires live SNMP server with error conditions
* SNMPv3 USM user cache management (``remove_v3_user_from_cache``) - requires SNMPv3 session with authenticated users

These code paths are tested through integration tests or are defensive error handling for 
rare system-level failures. The realistic unit test coverage target is approximately 75-80%.

To generate coverage reports, run::

    ./get_test_coverage.sh

The coverage report will be generated in ``coverage_html/index.html``.

Shimmed Net-SNMP Error Tests
============================
Some error-handling branches in the vendored Net-SNMP sources are extremely hard to hit with a
real agent (for example, crafted error PDUs that return ``SNMP_ERR_GENERR`` with a valid
``errindex``). To cover those branches deterministically, we add shim tests that interpose
``snmp_synch_response`` and return a fabricated response.

Why these shims exist
=====================
* They exercise packet error paths that otherwise require a misbehaving agent.
* They raise coverage for vendored Net-SNMP files without modifying the Net-SNMP code itself.
* They are isolated in dedicated test binaries so normal tests still use the real library calls.

How the shims work
==================
Each shim test defines a C symbol named ``snmp_synch_response``. During linking, this symbol is
preferred over the Net-SNMP library version for that test binary only. The shim constructs a
``netsnmp_pdu`` with ``SNMP_ERR_GENERR`` and a minimal variable list, then returns ``STAT_SUCCESS``.
The production code under test reads the fake response and raises ``PacketErrorBase``.

Shim test files
==============
* ``test_snmpwalk_shim.cpp``
* ``test_snmpbulkget_shim.cpp``
* ``test_snmpget_shim.cpp``
* ``test_snmpgetnext_shim.cpp``

Diagram: Shimmed Packet Error Flow
==================================
.. code-block:: text

    [test_snmp*_shim.cpp]
        |
        | defines snmp_synch_response()
        v
    +---------------------------+
    | fake netsnmp_pdu response |
    | errstat = SNMP_ERR_GENERR |
    | errindex = 1              |
    +---------------------------+
        |
        v
    [snmpget/snmpgetnext/snmpwalk/snmpbulkget]
        |
        | detects error in packet
        v
      PacketErrorBase thrown

----

.. note::
   This content was generated by AI and reviewed by humans. Mistakes may still occur. PRs for corrections are welcome.

